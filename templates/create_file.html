<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    {% set page_title = 'Dewey File Manager' %}
    <title>{{ page_title }}</title>

    {% set bloom_mod = 'dewey' %}

    <link rel="stylesheet" type="text/css" href="{{ style.skin_css }}">
    <link rel="stylesheet" type="text/css" href="static/style.css">
    <script src="static/action_buttons.js"></script>
    
    <style>
        .floating-button {
            position: fixed;
            padding: 10px;
            z-index: 1000;
            background-color: var(--primary-color);
            color: white;
            border: none;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            cursor: pointer;
            border-radius: 50%;
        }

        .floating-button.download-tsv {
            top: 20px;
            right: 20px;
        }

        .floating-button.create-set {
            bottom: 10px;
            right: 10px;
        }

        .floating-button.download {
            bottom: 10px;
            left: 10px;
        }

        .form-section {
            display: inline-block;
            margin: 0 7.5%;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }

        .form-section label, .form-section input, .form-section select, .form-section textarea {
            margin: 5px 0;
            vertical-align: middle;
        }

        .form-group {
            display: flex;
            align-items: center;
        }

        .form-group label {
            width: 100px;
            margin-right: 10px;
        }

        .form-group input, .form-group select, .form-group textarea {
            flex: 1;
        }

        .glow {
            box-shadow: 0 0 10px fuchsia;
            transition: box-shadow 0.5s ease-in-out;
        }

        th {
            cursor: pointer;
        }

        th.ascending::after {
            content: ' \25B2';
        }

        th.descending::after {
            content: ' \25BC';
        }
    </style>
    <script>
        async function triggerDownload(url) {
            return new Promise((resolve) => {
                const link = document.createElement('a');
                link.href = url;
                link.download = '';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                resolve();
            });
        }

        async function downloadFile(euid, downloadType, createMetadataFile) {
            console.log(`Downloading file for EUID: ${euid}`);

            const formData = new URLSearchParams();
            formData.append('euid', euid);
            formData.append('download_type', downloadType);
            formData.append('create_metadata_file', createMetadataFile);
            formData.append('ret_json', 'True');

            const response = await fetch(`/download_file`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: formData.toString()
            });

            if (response.ok) {
                const jsonResponse = await response.json();
                const fileDownloadPath = jsonResponse.file_download_path;
                const metadataDownloadPath = jsonResponse.metadata_download_path;

                console.log('fileDownloadPath:', fileDownloadPath);
                console.log('metadataDownloadPath:', metadataDownloadPath);

                // Trigger downloads
                await triggerDownload(fileDownloadPath);
                if (metadataDownloadPath) {
                    await triggerDownload(metadataDownloadPath);
                }
            } else {
                console.error(`Failed to download file for EUID: ${euid}`);
            }
        }

        async function downloadSelectedFiles() {
            const euid = document.getElementById('euid').value;
            const downloadType = document.getElementById('download-type').value;
            const createMetadataFile = document.getElementById('create_metadata_file').value;

            if (euid) {
                await downloadFile(euid, downloadType, createMetadataFile);
            } else {
                console.error('No EUID specified.');
            }
        }
    </script>
</head>
<body>
    {% include 'bloom_header.html' %}

    <h1>File Tools</h1>
    <hr>
    
    <button class="accordion" style="width: -webkit-fill-available;">Register File(s)</button>
    <div class="accordion-content">
        <ul>
        <form id="createFileForm" action="create_file" method="post" enctype="multipart/form-data">
            <input type="hidden" name="upload_group_key" value="{{ upload_group_key }}">
            <table>
                <tr><td>
            <input type="hidden" value="na" id="name" name="name">
            
            <h3>Specify Files</h3>
            <hr>
            <ul>
            <label for="file_data">A Local File:</label>
            <input type="file" id="file_data" name="file_data">
            <br><br>

            <label for="directory">A Directory Of Files <br>(RECURSIVE, max 1k files):</label>
            <input type="file" id="directory" name="directory" webkitdirectory directory multiple>
            <br><br>

            <label for="urls">Public URLs To Files (one per line):</label>
            <textarea id="urls" name="urls" rows="5" cols="25"></textarea>
            <br><br>
            
            <label for="s3_uris">S3 URIs (accessible to dewey):</label>
            <textarea id="s3_uris" name="s3_uris" rows="5" cols="28"></textarea>
            <br><br>
            </ul>
        </ul>

                </td><td> </td>
                <td>
                    <h3>Add Metadata</h3>
                    <ul>
                    <small>upload group key: <code>{{ upload_group_key }}</code></small>
                    <br>
<br>
            <label for="x_rcrf_patient_uid">RCRF Patient ID:</label>
            <input type="text" id="x_rcrf_patient_uid" name="x_rcrf_patient_uid"><br><br>
            <label for="x_study_id">Study ID:</label>
            <input type="text" id="x_study_id" name="x_study_id"><br><br>
            <label for="x_clinician_id">Clinician ID:</label>
            <input type="text" id="x_clinician_id" name="x_clinician_id"><br><br>
            <label for="x_health_event_id">Health Event:</label>
            <input type="text" id="x_health_event_id" name="x_health_event_id"><br><br>
            <label for="lab_code">Lab Code:</label>
            <input type="text" id="lab_code" name="lab_code"><br><br>
            <label for="x_relevant_datetime">Original File Creation Datetime:</label>
            <input type="datetime-local" id="x_relevant_datetime" name="x_relevant_datetime"><br><br>
            <label for="comments">Comments:</label>
            <textarea id="comments" name="comments"></textarea><br><br>
        </td></tr>
        <tr><td> </td>
            <td>
            <button type="submit">Create</button>
            </td><td> </td></tr></table>
                    </ul>
                </td></tr></table>
        </form>
    </div>
    <hr><hr>

    <button class="accordion" style="width: -webkit-fill-available;">Download File</button>
    <div class="accordion-content">
        <ul><ul>
        <form id="downloadFileForm" onsubmit="event.preventDefault(); downloadSelectedFiles();" method="post" enctype="multipart/form-data">
            <label for="euid">File EUID: </label>
            <input type="text" id="euid" name="euid"><br><br>
            
            <label for="download-type">File Creation Mode:</label> 
            <select id="download-type" name="download_type">
                <option value="dewey" selected>dewey</option>
                <option value="hybrid">hybrid</option>
                <option value="orig">orig</option>
            </select>
            <ul>File(s) downloaded will be named as follows:
                <ul>
                <li>dewey: <code>{euid}.{original_file_suffix}</code></li>
                <li>hybrid:<code> {euid}.{original_file_name}</code></li>
                <li>orig:<code> {original_file_name}</code></li>
                <ul> ... <b> <small>not advised: !greater risk of over-writing similar named files! use <code>*.dewey.yaml</code> file to work with original file info.</small></b>
                </ul>
            </ul></ul>
            <br>
         
            <label for="create_metadata_file">Generate dewey.yaml:</label>
            <select id="create_metadata_file" name="create_metadata_file">
                <option selected value="yes">yes</option>
                <option value="no">no</option>
            </select>
            <ul>Creates a companion <code>{downloaded_file}.dewey.yaml</code> file with key metadata assoc with the file.<ul>
                 (the exhaustive view of any object can be accessed via the<a href=euid_details?euid=GT1 target=neww>EUID Details View, ex: GT1</a>)
            </ul></ul>
            <br><br>
        
            <button type="submit">Download File</button>
        </form>
    </div>

    <hr><hr>
    <button class="accordion" style="width: -webkit-fill-available;">File Search (bulk d/l & create file sets)</button>
    <div class="accordion-content">
        <ul>
            <h3>Search Files</h3><ul>
            <table>
                <tr><td style="align:top;">
        <form id="searchFileForm" action="search_files" method="post" enctype="multipart/form-data">
            <input type="hidden" value="" id="euid" name="euid"><br>

            <label for="is_greedy">Greedy Search: </label>
            <select name="is_greedy">
                <option value="yes" selected>yes</option>
                <option value="no">no</option>
            </select>
            <br>
            <br>
            <label for="key">Specify search KEY and VALUE: </label>
            <ul>
            <small>
            CRUDE ATM. Manually set key and key value to search, up to 3 pairs (this is a limitation of my crude ui, not the db, which can use arbitrary numbers of search terms).
            </small></br>
            <br>
            <label for="key_1">Key 1: </label>
            <input type="text" id="key_1" name="key_1"><br>

            <label for="value_1">Value 1: </label>
            <input type="text" id="value_1" name="value_1"><br><br>

            <label for="key_2">Key 2: </label>
            <input type="text" id="key_2" name="key_2"><br>

            <label for="value_2">Value 2: </label>
            <input type="text" id="value_2" name="value_2"><br><br>

            <label for="key_3">Key 3: </label>
            <input type="text" id="key_3" name="key_3"><br>

            <label for="value_3">Value 3: </label>
            <input type="text" id="value_3" name="value_3"><br>
            <br>
        </ul>
        <button type="submit">Search Files</button>
        </form>

        </td><td> 
            <ul>
            Keys available in all File records.
                <pre>
            "lab_code":"",
            "original_file_name": "",
            "original_file_path": "",
            "original_file_size_bytes": "",
            "original_file_md5": "",
            "original_server_ip": "",
            "original_local_server_name": "",
            "original_file_suffix": "",
            "current_s3_key": "",
            "current_s3_bucket_name": "",
            "x_rcrf_patient_uid": "",
            "x_clinician_id": "",
            "x_relevant_datetime": "",
            "x_health_event_id": "",
            "x_study_id": "",
            "upload_group_key": ""
                </pre>
    </ul>
    </td>
    </tr></table>
    </ul></ul>
    </div>

    <hr><hr>

    <button class="accordion" style="width: -webkit-fill-available;">Create File Set</button>
    <div class="accordion-content">

        <ul>
        <h3>Create A File Set</h3>
        <ul>
        <form action="/create_file_set" method="post">
            <label for="file_set_name">File Set Name:</label>
            <input type="text" id="file_set_name" name="file_set_name" required><br><br>
    
            <label for="file_set_description">File Set Description:</label>
            <input type="text" id="file_set_description" name="file_set_description" required><br><br>
    
            <label for="file_set_tag">File Set Tag:</label>
            <input type="text" id="file_set_tag" name="file_set_tag" required><br><br>
    
            <label for="comments">Comments:</label>
            <input type="text" id="comments" name="comments"><br><br>
    
            <label for="file_euids">File EUIDs :</label>
            <textarea id="file_euids" name="file_euids" required></textarea>
            <br><br>
            <button type="submit">Create File Set</button>
        </form>
    </div>

    <hr><hr>

    <button class="accordion" style="width: -webkit-fill-available;">Search File Sets</button>
    <div class="accordion-content">
        <ul>
            <h3>Search File Sets By</h3>
            <form id="searchFileSetForm" action="search_file_sets" method="post" enctype="multipart/form-data">
                <label for="file_set_name">Name: </label>
                <input type="text" id="file_set_name" name="file_set_name" value=""><br><br>

                <label for="file_set_description">Description: </label>
                <input type="text" id="file_set_description" name="file_set_description" value=""><br><br>

                <label for="file_set_tag">Tag: </label>
                <input type="text" id="file_set_tag" name="file_set_tag" value=""><br><br>

                <label for="comments">Comments: </label>
                <input type="text" id="comments" name="comments" value=""><br><br>

                <label for="file_euids">File EUIDs (not working presentle): </label>
                <input type="text" id="file_euids" name="file_euids" value=""><br><br>

                <label for="is_greedy">Greedy Search: </label>
                <select name="is_greedy">
                    <option value="yes" selected>yes</option>
                    <option value="no">no</option>
                </select><br><br>

                <button type="submit">Search File Sets</button>
            </form>
        
    </div>

    <script>
        function resetForms() {
            document.getElementById('createFileForm').reset();
            document.getElementById('downloadFileForm').reset();
            document.getElementById('searchFileForm').reset();
            document.getElementById('searchFileSetForm').reset();
        }

        window.onload = resetForms;

        window.addEventListener('pageshow', function(event) {
            if (event.persisted || (window.performance && window.performance.navigation.type === 2)) {
                resetForms();
            }
        });
    </script>
    {% include 'pre_body_close.html' %}

</body>
</html>
