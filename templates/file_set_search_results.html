<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    {% set page_title = 'File Search Results' %}
    <title>{{ page_title }}</title>
    {% set bloom_mod = 'dewey' %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <link rel="stylesheet" type="text/css" href="{{ style.skin_css }}">
    <link rel="stylesheet" type="text/css" href="static/style.css">
</head>
<body>
    {% include 'bloom_header.html' %}

    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1 style="margin:0;">{{ num_results }} Results</h1>
        <div>
            <button onclick="openColumnModal()" type="button">Edit Column Order</button>
            <button onclick="downloadTableAsTSV()" type="button">⬇️</button>
        </div>
    </div>
    <div id="column-modal" title="Column Order" style="display:none;">
        <ul id="column-list">{% for col in columns %}<li class="ui-state-default" data-col="{{ col }}">{{ col }}</li>{% endfor %}</ul>
        <button onclick="saveColumnOrder()" type="button">Save</button>
    </div>

    <table id="results-table" border="1">
        <thead>
            <tr>
                <th>Link</th> <!-- New column header for the link -->
                {% for column in columns %}
                <th onclick="sortTableByHeader(this)">{{ column }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in table_data %}
            <tr>
                <td>
                    {% if row['ref_type'] == 'presigned_url' %}
                    <a href="/file_set_urls?fs_euid={{ row['EUID'] }}" target="_blank">View Presigned URLSs</a>
                    {% endif %}
                </td> <!-- New cell with the link -->
                {% for column in columns %}
                <td>
                    {% if column == 'EUID' %}
                    <a target="_blank" href="euid_details?euid={{ row[column] }}">{{ row[column] }}</a>
                    {% else %}
                    {{ row[column] }}
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <a href="/dewey">Go Back</a>

    <script>
        let sortDirections = Array({{ columns | length }}).fill(true); // Track sort direction for each column

        function sortTableByHeader(header) {
            const table = document.getElementById('results-table');
            const columnIndex = Array.from(header.parentNode.children).indexOf(header) - 1; // subtract 1 for the link column
            if (columnIndex < 0) return;
            const tbody = table.tBodies[0];
            const rows = Array.from(tbody.rows);

            const direction = sortDirections[columnIndex] ? 1 : -1;

            const sortedRows = rows.sort((a, b) => {
                const cellA = a.cells[columnIndex + 1].innerText.toLowerCase();
                const cellB = b.cells[columnIndex + 1].innerText.toLowerCase();

                if (cellA < cellB) return -1 * direction;
                if (cellA > cellB) return 1 * direction;
                return 0;
            });

            tbody.append(...sortedRows);
            sortDirections[columnIndex] = !sortDirections[columnIndex];
        }

        function downloadTableAsTSV() {
            const table = document.getElementById('results-table');
            const rows = Array.from(table.rows);
            const tsv = rows.map(row => {
                const cells = Array.from(row.cells);
                return cells.map(cell => cell.innerText).join('\t');
            }).join('\n');

            const tsvFile = new Blob([tsv], { type: 'text/tab-separated-values' });
            const downloadLink = document.createElement('a');
            const now = new Date();
            const timestamp = now.toISOString().slice(0, 19).replace(/[:T]/g, '-');
            downloadLink.download = `dewey_file_set_${timestamp}.tsv`;
            downloadLink.href = URL.createObjectURL(tsvFile);
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }
    </script>
<script>
    $(function(){
        $("#column-list").sortable();
        $("#column-modal").dialog({ autoOpen: false, modal: true });
    });
    function openColumnModal(){
        $("#column-modal").dialog("open");
    }
    function saveColumnOrder(){
        const order = $("#column-list").sortable("toArray", { attribute: "data-col" });
        $.ajax({url: "/update_preference", type: "POST", contentType: "application/json", data: JSON.stringify({key: "file_set_search_columns_order", value: order}), success: function(){ location.reload(); }});
    }
</script>

    <style>
        th {
            cursor: pointer;
        }
    </style>
</body>
</html>
