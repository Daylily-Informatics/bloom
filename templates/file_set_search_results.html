<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    {% set page_title = 'File Search Results' %}
    <title>{{ page_title }}</title>
    {% set bloom_mod = 'dewey' %}
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>

    <link rel="stylesheet" type="text/css" href="{{ style.skin_css }}">
    <link rel="stylesheet" type="text/css" href="static/style.css">
</head>
<body>
    {% include 'bloom_header.html' %}

    <h1>{{ num_results }} Results</h1>
    <button onclick="openColumnModal()" type="button">Edit Column Order</button>
    <div id="column-modal" title="Column Order" style="display:none;">
        <ul id="column-list">{% for col in columns %}<li class="ui-state-default" data-col="{{ col }}">{{ col }}</li>{% endfor %}</ul>
        <button onclick="saveColumnOrder()" type="button">Save</button>
    </div>

    <form id="shareFileSetForm" action="/share_file_set" method="post">
        <div class="form-section" style="background-color: rgba(204, 255, 204, 0.1);">
            <label for="ref_type">Share Files In Set?</label>
            <select id="ref_type" name="ref_type" onchange="toggleRcloneOptions()">
                <option value="presigned_url">Create Presigned S3 URLS Per File</option>
                <option value="rclone serve http">Share File Set Via HTTP</option>
                <option value="rclone serve sftp">Share File Set Via SFTP</option>
            </select><br>
            <div id="rclone-options" style="display:none;">
                <small><a href=https://rclone.org/commands/rclone_serve/>rclone serve</a> is magic & free</small>
                <br><br>
                bucket:<input type="text" name="bucket" value="{{ s3_bucket_prefix }}"> //
                host:<input type="text" name="host" value="0.0.0.0"> // port:<input type="text" name="port" value="8080"> <br>
                user:<input type="text" name="user" value="user"> // pass:<input type="text" name="passwd" value="passwd">
            </div>
            <label for="duration"> Share Duration (days, float acceptable): </label>
            <input type="text" id="duration" name="duration" value="1" style="width:30px;">
            <input type="hidden" id="selected_fs_euid" name="fs_euid">
            <button onclick="shareFileSet(event)">Share File Set</button>
        </div>
    </form>

    <table id="results-table" border="1">
        <thead>
            <tr>
                <th>Select</th>
                <th>Link</th> <!-- New column header for the link -->
                {% for column in columns %}
                <th onclick="sortTable({{ loop.index0 }})">{{ column }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for row in table_data %}
            <tr>
                <td><input type="radio" name="fs_select" value="{{ row['EUID'] }}"></td>
                <td>
                    {% if row['ref_type'] == 'presigned_url' %}
                    <a href="/file_set_urls?fs_euid={{ row['EUID'] }}" target="_blank">View Presigned URLSs</a>
                    {% endif %}
                </td> <!-- New cell with the link -->
                {% for column in columns %}
                <td>
                    {% if column == 'EUID' %}
                    <a target="_blank" href="euid_details?euid={{ row[column] }}">{{ row[column] }}</a>
                    {% else %}
                    {{ row[column] }}
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <a href="/dewey">Go Back</a>

    <button class="floating-button" onclick="downloadTableAsTSV()">⬇️ Download TSV</button>

    <script>
        let sortDirections = Array({{ columns | length }}).fill(true); // Track sort direction for each column

        function sortTable(columnIndex) {
            const table = document.getElementById('results-table');
            const tbody = table.tBodies[0];
            const rows = Array.from(tbody.rows);

            const direction = sortDirections[columnIndex] ? 1 : -1;

            const sortedRows = rows.sort((a, b) => {
                const cellA = a.cells[columnIndex + 1].innerText.toLowerCase(); // +1 because of new first column
                const cellB = b.cells[columnIndex + 1].innerText.toLowerCase();

                if (cellA < cellB) return -1 * direction;
                if (cellA > cellB) return 1 * direction;
                return 0;
            });

            tbody.append(...sortedRows);
            sortDirections[columnIndex] = !sortDirections[columnIndex]; // Toggle sort direction
        }

        function downloadTableAsTSV() {
            const table = document.getElementById('results-table');
            const rows = Array.from(table.rows);
            const tsv = rows.map(row => {
                const cells = Array.from(row.cells);
                return cells.map(cell => cell.innerText).join('\t');
            }).join('\n');

            const tsvFile = new Blob([tsv], { type: 'text/tab-separated-values' });
            const downloadLink = document.createElement('a');
            const now = new Date();
            const timestamp = now.toISOString().slice(0, 19).replace(/[:T]/g, '-');
            downloadLink.download = `dewey_file_set_${timestamp}.tsv`;
            downloadLink.href = URL.createObjectURL(tsvFile);
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }
    </script>
<script>
    $(function(){
        $("#column-list").sortable();
        $("#column-modal").dialog({ autoOpen: false, modal: true });
    });
    function openColumnModal(){
        $("#column-modal").dialog("open");
    }
    function saveColumnOrder(){
        const order = $("#column-list").sortable("toArray", { attribute: "data-col" });
        $.ajax({url: "/update_preference", type: "POST", contentType: "application/json", data: JSON.stringify({key: "file_set_search_columns_order", value: order}), success: function(){ location.reload(); }});
    }
</script>

    <script>
        function shareFileSet(event) {
            event.preventDefault();
            const selected = document.querySelector('input[name="fs_select"]:checked');
            if (!selected) { alert('Please select a file set.'); return; }
            document.getElementById('selected_fs_euid').value = selected.value;
            document.getElementById('shareFileSetForm').submit();
        }

        function toggleRcloneOptions() {
            var refType = document.getElementById("ref_type").value;
            var rcloneOptions = document.getElementById("rclone-options");
            if (refType.startsWith("rclone")) {
                rcloneOptions.style.display = "block";
            } else {
                rcloneOptions.style.display = "none";
            }
        }

        document.addEventListener("DOMContentLoaded", function() {
            toggleRcloneOptions();
        });
    </script>

    <style>
        .floating-button {
            position: fixed;
            bottom: 10px;
            right: 10px;
            padding: 10px;
            background-color: #008CBA; /* Blue background */
            color: white; /* White text */
            border: none;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            cursor: pointer;
            border-radius: 50%;
        }

        th {
            cursor: pointer;
        }
    </style>
</body>
</html>
